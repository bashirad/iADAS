const e={legacyFormat:"Jet4",pageSize:4096,textEncoding:"ucs-2",dataPage:{recordCountOffset:12,record:{countOffset:12,columnCountSize:2}},tableDefinitionPage:{rowCountOffset:16,variableColumnCountOffset:43,columnCountOffset:45,logicalIndexCountOffset:47,realIndexCountOffset:51,realIndexStartOffset:63,realIndexEntrySize:12,columnsDefinition:{typeOffset:0,indexOffset:5,variableIndexOffset:7,flagsOffset:15,fixedIndexOffset:21,sizeOffset:23,entrySize:25},columnNames:{nameLengthSize:2},usageMapOffset:55}},t=e,n=t,i=n,o=i,a=o,r={legacyFormat:"Jet3",pageSize:2048,textEncoding:"utf8",dataPage:{recordCountOffset:8,record:{countOffset:8,columnCountSize:1}},tableDefinitionPage:{rowCountOffset:12,columnCountOffset:25,variableColumnCountOffset:25,logicalIndexCountOffset:27,realIndexCountOffset:31,realIndexStartOffset:43,realIndexEntrySize:8,columnsDefinition:{typeOffset:0,indexOffset:1,variableIndexOffset:3,flagsOffset:13,fixedIndexOffset:14,sizeOffset:16,entrySize:18},columnNames:{nameLengthSize:1},usageMapOffset:35}},s=e,f=Buffer.from("MSISAM Database","ascii");var l;!function(e){e[e.DatabaseDefinitionPage=0]="DatabaseDefinitionPage",e[e.DataPage=1]="DataPage",e[e.TableDefinition=2]="TableDefinition",e[e.IntermediateIndexPage=3]="IntermediateIndexPage",e[e.LeafIndexPages=4]="LeafIndexPages",e[e.PageUsageBitmaps=5]="PageUsageBitmaps"}(l||(l={}));var u,c=l;function d(e,t){if(e[0]!==t)throw new Error(`Wrong page type. Expected ${t} but received ${e[0]}.`)}class h{constructor(l){this.buffer=l,d(this.buffer,c.DatabaseDefinitionPage),this.format=function(l){const u=l[20];switch(u){case 0:return r;case 1:return l.slice(4,4+f.length).equals(f)?s:e;case 2:return t;case 3:return n;case 4:return i;case 5:return o;case 6:return a;default:throw new Error(`Unsupported version '${u}'`)}}(this.buffer)}getPage(e){const t=e*this.format.pageSize;if(this.buffer.length<t)throw new Error(`Page ${e} does not exist`);return this.buffer.slice(t,t+this.format.pageSize)}findPageRow(e){const t=e>>8,n=255&e,i=this.getPage(t);return this.findRow(i,n)}findRow(e,t){const n=this.format.dataPage.recordCountOffset;if(t>1e3)throw new Error("Cannot read rows > 1000");const i=e.readUInt16LE(n+2+2*t),o=0===t?this.format.pageSize:e.readUInt16LE(n+2*t);return e.slice(i,o)}}!function(e){e[e.Form=0]="Form",e[e.Table=1]="Table",e[e.Macro=2]="Macro",e[e.SystemTable=3]="SystemTable",e[e.Report=4]="Report",e[e.Query=5]="Query",e[e.LinkedTable=6]="LinkedTable",e[e.Module=7]="Module",e[e.Relationship=8]="Relationship",e[e.DatabaseProperty=11]="DatabaseProperty"}(u||(u={}));const g={1:"boolean",2:"byte",3:"integer",4:"long",5:"currency",6:"float",7:"double",8:"datetime",9:"binary",10:"text",11:"ole",12:"memo",15:"repid",16:"numeric",18:"complex",19:"bigint",20:"datetimextended"};function m(e){const t=g[e];if(void 0===t)throw new Error("Unsupported column type");return t}function b(e){return e.readInt32LE()}function I(e){const t=[...e],n=t.length;for(let e=0;e<n-1;++e)t[e+1]+=Math.floor(t[e]/10),t[e]=t[e]%10;return t[n-1]=t[n-1]%10,t}function p(e,t){if(e.length!==t.length)throw new Error("Array a and b must have the same length");const n=new Array(e.length).fill(0);for(let i=0;i<e.length;++i)if(0!==e[i])for(let o=0;o<t.length;o++)n[i+o]+=e[i]*t[o];return I(n.slice(0,e.length))}function x(e,t){if(e.length!==t.length)throw new Error("Array a and b must have the same length");const n=e.length,i=[];for(let o=0;o<n;++o)i[o]=e[o]+t[o];return I(i)}function P(e,t){return I([e,...new Array(t-1).fill(0)])}function D(e,t,n){let i,o="";for(n&&(o+="-"),i=e.length;i>0&&i-1>t&&!e[i-1];i--);if(0===i)o+="0";else for(let n=i;n>0;n--)n===t&&(o+="."),o+=e[n-1].toString();return o}function w(e,t){if("utf8"===t.textEncoding)return e.toString("utf8");if(e.length<=2||255!=(255&e.readUInt8(0))||254!=(255&e.readUInt8(1)))return e.toString("ucs-2");let n=!0,i=2;const o=Buffer.alloc(2*(e.length-i));let a=0;for(;i<e.length;){const t=e.readUInt8(i++);0===t?n=!n:n?(o[a++]=t,o[a++]=0):e.length-i>=2&&(o[a++]=t,o[a++]=e.readUInt8(i++))}return o.slice(0,a).toString("ucs-2")}const y={binary:function(e){const t=Buffer.alloc(e.length);return e.copy(t),t},byte:function(e){return e.readUInt8()},complex:b,currency:function(e){let t=P(0,20),n=P(1,20);const i=e.slice(0,8);let o=!1;if(128&i[7]){o=!0;for(let e=0;e<8;++e)i[e]=~i[e];for(let e=0;e<8&&(++i[e],0==i[e]);++e);}for(const e of i)t=x(t,p(n,P(e,20))),n=p(n,P(256,20));return D(t,4,o)},datetime:function(e){const t=e.readDoubleLE();return new Date(Math.round(86400*(t-25569)*1e3))},double:function(e){return e.readDoubleLE()},float:function(e){return e.readFloatLE()},integer:function(e){return e.readInt16LE()},long:b,text:function(e,t,n){return w(e,n.format)},memo:function(e,t,n){const i=e.readUIntLE(0,3),o=e.readUInt8(3);if(128&o)return w(e.slice(12,12+i),n.format);if(64&o){const t=e.readUInt32LE(4);return w(n.findPageRow(t).slice(0,i),n.format)}if(0===o){let t=e.readInt32LE(4),o=Buffer.alloc(0);do{const a=n.findPageRow(t);if(o.length+a.length-4>i)break;if(0===a.length)break;o=Buffer.concat([o,a.slice(4,e.length)]),t=a.readInt32LE(0)}while(0!==t);return w(o.slice(0,i),n.format)}throw new Error(`Unknown memo type ${o}`)},numeric:function(e,t){let n=P(0,40),i=P(1,40);const o=e.slice(1,17);for(let e=0;e<o.length;++e){n=x(n,p(i,P(o[12-4*Math.floor(e/4)+e%4],40))),i=p(i,P(256,40))}const a=!!(128&e[0]);return D(n,t.scale,a)},ole:function(e,t,n){const i=e.readUIntLE(0,3),o=e.readUInt8(3);if(128&o)return e.slice(12,12+i);if(64&o){const t=e.readUInt32LE(4);return n.findPageRow(t).slice(0,i)}if(0===o){let t=e.readInt32LE(4),o=Buffer.alloc(0);do{const a=n.findPageRow(t);if(o.length+a.length-4>i)break;if(0===a.length)break;o=Buffer.concat([o,a.slice(4,e.length)]),t=a.readUInt32LE(0)}while(0!==t);return o.slice(0,i)}throw new Error(`Unknown memo type ${o}`)},repid:function(e){return e.slice(0,4).swap32().toString("hex")+"-"+e.slice(4,6).swap16().toString("hex")+"-"+e.slice(6,8).swap16().toString("hex")+"-"+e.slice(8,10).toString("hex")+"-"+e.slice(10,16).toString("hex")},bigint:void 0,datetimextended:void 0};function E(e,t,n){if("boolean"===t.type)throw new Error("readFieldValue does not handle type boolean");const i=y[t.type];return i?i(e,t,n):`Column type ${t.type} is currently not supported`}function C(e,t){const n=t%8;return!!(e[Math.floor(t/8)]&1<<n)}function O(e){return Math.floor((e+7)/8)}function U(e,t){switch(e[0]){case 0:return function(e){const t=e.readUInt32LE(1);return L(e.slice(5),t)}(e);case 1:return function(e,t){const n=8*(t.format.pageSize-4),i=Math.floor((e.length-1)/4),o=[];for(let a=0;a<i;++a){const i=e.readUInt32LE(1+4*a);if(0===i)continue;const r=t.getPage(i);d(r,c.PageUsageBitmaps);const s=r.slice(4);o.push(...L(s,a*n))}return o}(e,t);default:throw new Error("Unknown usage map type")}}function L(e,t){const n=[];for(let i=0;i<8*e.length;i++)C(e,i)&&n.push(t+i);return n}class S{constructor(e,t,n){this.name=e,this.db=t,this.firstDefinitionPage=n;let i,o=this.firstDefinitionPage;for(;o>0;){const e=this.db.getPage(o);d(e,c.TableDefinition),i=i?Buffer.concat([i,e.slice(8)]):e,o=e.readUInt32LE(4)}this.definitionBuffer=i,this.rowCount=this.definitionBuffer.readUInt32LE(this.db.format.tableDefinitionPage.rowCountOffset),this.columnCount=this.definitionBuffer.readUInt16LE(this.db.format.tableDefinitionPage.columnCountOffset),this.variableColumnCount=this.definitionBuffer.readUInt16LE(this.db.format.tableDefinitionPage.variableColumnCountOffset),this.fixedColumnCount=this.columnCount-this.variableColumnCount,this.logicalIndexCount=this.definitionBuffer.readInt32LE(this.db.format.tableDefinitionPage.logicalIndexCountOffset),this.realIndexCount=this.definitionBuffer.readInt32LE(this.db.format.tableDefinitionPage.realIndexCountOffset);const a=this.db.findPageRow(this.definitionBuffer.readUInt32LE(this.db.format.tableDefinitionPage.usageMapOffset));this.dataPages=U(a,this.db)}getColumn(e){const t=this.getColumns().find((t=>t.name===e));if(void 0===t)throw new Error(`Could not find column with name ${e}`);return t}getColumns(){const e=this.getColumnDefinitions();return e.sort(((e,t)=>e.index-t.index)),e.map((({index:e,variableIndex:t,fixedIndex:n,...i})=>i))}getColumnDefinitions(){const e=[];let t=this.db.format.tableDefinitionPage.realIndexStartOffset+this.realIndexCount*this.db.format.tableDefinitionPage.realIndexEntrySize,n=t+this.columnCount*this.db.format.tableDefinitionPage.columnsDefinition.entrySize;for(let o=0;o<this.columnCount;++o){const o=this.definitionBuffer.slice(t,t+this.db.format.tableDefinitionPage.columnsDefinition.entrySize),a=m(this.definitionBuffer.readUInt8(t+this.db.format.tableDefinitionPage.columnsDefinition.typeOffset)),r=this.definitionBuffer.readUIntLE(n,this.db.format.tableDefinitionPage.columnNames.nameLengthSize);n+=this.db.format.tableDefinitionPage.columnNames.nameLengthSize;const s=w(this.definitionBuffer.slice(n,n+r),this.db.format);n+=r;const f={name:s,type:a,index:o.readUInt8(this.db.format.tableDefinitionPage.columnsDefinition.indexOffset),variableIndex:o.readUInt8(this.db.format.tableDefinitionPage.columnsDefinition.variableIndexOffset),size:"boolean"===a?0:o.readUInt16LE(this.db.format.tableDefinitionPage.columnsDefinition.sizeOffset),fixedIndex:o.readUInt16LE(this.db.format.tableDefinitionPage.columnsDefinition.fixedIndexOffset),...(i=o.readUInt8(this.db.format.tableDefinitionPage.columnsDefinition.flagsOffset),{fixedLength:!!(1&i),nullable:!!(2&i),autoLong:!!(4&i),autoUUID:!!(64&i)})};"numeric"===a&&(f.precision=o.readUInt8(11),f.scale=o.readUInt8(12)),e.push(f),t+=this.db.format.tableDefinitionPage.columnsDefinition.entrySize}var i;return e}getColumnNames(){return this.getColumns().map((e=>e.name))}getData(e){var t,n;const i=[],o=this.getColumnDefinitions().filter((t=>void 0===(null==e?void 0:e.columns)||e.columns.includes(t.name))),a=null!==(t=null==e?void 0:e.rowOffset)&&void 0!==t?t:0,r=null!==(n=null==e?void 0:e.rowLimit)&&void 0!==n?n:1/0;for(const e of this.dataPages)i.length>=a+r||i.push(...this.getDataFromPage(e,o));return i.slice(a,a+r)}getDataFromPage(e,t){const n=this.db.getPage(e);if(d(n,c.DataPage),n.readUInt32LE(4)!==this.firstDefinitionPage)throw new Error(`Data page ${e} does not belong to table ${this.name}`);const i=n.readUInt16LE(this.db.format.dataPage.recordCountOffset),o=[];for(let e=0;e<i;++e){const t=8191;let i=n.readUInt16LE(this.db.format.dataPage.record.countOffset+2+2*e);if(16384&i)continue;i&=t;const a=i+((0===e?this.db.format.pageSize:n.readUInt16LE(this.db.format.dataPage.record.countOffset+2*e)&t)-i)-1;o.push({start:i,end:a})}const a=Math.max(...t.map((e=>e.index)),0),r=[];for(const e of o){const i=e.start,o=e.end,s=n.readUIntLE(i,this.db.format.dataPage.record.columnCountSize),f=O(s);let l=0;const u=[];if(this.variableColumnCount>0)switch(this.db.format.legacyFormat){case"Jet3":{l=n.readUInt8(o-f);const e=o-i+1;let t=Math.floor((e-1)/256);const a=o-f-t-1;(a-i-l)/256<t&&--t;let r=0;for(let e=0;e<l+1;++e){for(;r<t&&e===n.readUInt8(o-f-r-1);)++r;u.push(n.readUInt8(a-e)+256*r)}break}case"Jet4":l=n.readUInt16LE(o-f-1);for(let e=0;e<l+1;++e)u.push(n.readUInt16LE(o-f-3-2*e))}const c=s-l,d=n.slice(o-f+1,o-f+1+O(a+1));let h=0;const g={};for(const e of[...t].sort(((e,t)=>e.index-t.index))){let t,o,a;if(C(d,e.index)||(t=null),e.fixedLength&&h<c){o=i+(e.fixedIndex+this.db.format.dataPage.record.columnCountSize),a=e.size,++h}else if(!e.fixedLength&&e.variableIndex<l){const t=u[e.variableIndex];o=i+t,a=u[e.variableIndex+1]-t}else o=0,t=null,a=0;"boolean"===e.type?t=void 0===t:null!==t&&(t=E(n.slice(o,o+a),e,this.db)),g[e.name]=t}r.push(g)}return r}}class v{constructor(e){this.buffer=e,d(this.buffer,c.DatabaseDefinitionPage),this.db=new h(this.buffer);const t=new S("MSysObjects",this.db,2).getData({columns:["Id","Name","Type","Flags"]});this.sysObjects=t.map((e=>{const t=127&e.Type;return{objectName:e.Name,objectType:(n=t,Object.values(u).includes(n)?t:null),tablePage:16777215&e.Id,flags:e.Flags};var n}))}getFormat(){return this.db.format.legacyFormat}getTableNames({normalTables:e,systemTables:t,linkedTables:n}={normalTables:!0,systemTables:!1,linkedTables:!1}){const i=[];for(const o of this.sysObjects)o.objectType===u.Table?0==(-2147483646&o.flags)?e&&i.push(o):t&&i.push(o):o.objectType===u.LinkedTable&&n&&i.push(o);return i.map((e=>e.objectName))}getTable(e){const t=this.sysObjects.filter((e=>e.objectType===u.Table)).find((t=>t.objectName===e));if(!t)throw new Error(`Could not find table with name ${e}`);return new S(e,this.db,t.tablePage)}}export{v as default};
